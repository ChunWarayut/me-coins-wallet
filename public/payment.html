<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô - PromptPay</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      max-width: 500px;
      width: 100%;
      text-align: center;
    }
    
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    
    .payment-info {
      background: #f7f9fc;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      text-align: left;
    }
    
    .payment-info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      font-size: 14px;
    }
    
    .payment-info-row:last-child {
      margin-bottom: 0;
      padding-top: 12px;
      border-top: 2px solid #e1e8ed;
      font-size: 18px;
      font-weight: bold;
    }
    
    .payment-info-label {
      color: #666;
    }
    
    .payment-info-value {
      color: #333;
      font-weight: 600;
    }
    
    .qr-container {
      background: white;
      border: 2px solid #e1e8ed;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      display: inline-block;
    }
    
    .qr-container img {
      max-width: 280px;
      width: 100%;
      height: auto;
      display: block;
    }
    
    .instructions {
      color: #666;
      font-size: 14px;
      margin: 20px 0;
      line-height: 1.6;
    }
    
    .status {
      display: inline-block;
      padding: 12px 24px;
      border-radius: 25px;
      font-size: 16px;
      font-weight: 600;
      margin: 20px 0;
    }
    
    .status.pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .status.succeeded {
      background: #d4edda;
      color: #155724;
    }
    
    .status.failed {
      background: #f8d7da;
      color: #721c24;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      font-size: 14px;
    }
    
    .btn {
      padding: 14px 28px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
      margin-top: 20px;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: #f7f9fc;
      color: #667eea;
      margin-left: 10px;
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üí≥ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h1>
    <p class="subtitle">‡∏ä‡∏≥‡∏£‡∏∞‡∏ú‡πà‡∏≤‡∏ô PromptPay</p>
    
    <div id="loadingSection">
      <!-- <div class="loading" style="width: 40px; height: 40px;"></div> -->
      <p style="margin-top: 20px; color: #666;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô...</p>
    </div>
    
    <div id="paymentSection" class="hidden">
      <div class="payment-info">
        <div class="payment-info-row">
          <span class="payment-info-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</span>
          <span class="payment-info-value" id="description">-</span>
        </div>
        <div class="payment-info-row">
          <span class="payment-info-label">Payment ID:</span>
          <span class="payment-info-value" id="paymentId" style="font-size: 11px; word-break: break-all;">-</span>
        </div>
        <div class="payment-info-row">
          <span class="payment-info-label">‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞:</span>
          <span class="payment-info-value" id="amount">-</span>
        </div>
      </div>
      
      <div class="qr-container" id="qrContainer">
        <img id="qrImage" src="" alt="QR Code PromptPay" />
      </div>
      
      <div class="instructions">
        üì± ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡∏î‡πâ‡∏ß‡∏¢‡πÅ‡∏≠‡∏õ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>
        ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô PromptPay
      </div>
      
      <div class="status pending" id="statusBadge">
        <!-- <span class="loading"></span> -->
        <span id="statusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô...</span>
      </div>
      
      <div id="successSection" class="hidden">
        <p style="color: #155724; font-size: 18px; margin: 20px 0;">
          ‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏≥‡∏•‡∏±‡∏á redirect ‡∏Å‡∏•‡∏±‡∏ö...
        </p>
      </div>
    </div>
    
    <div id="errorSection" class="hidden">
      <div class="error-message" id="errorMessage"></div>
      <a href="/" class="btn">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
    </div>
  </div>

  <script>
    const API_BASE_URL = window.location.origin;
    
    // ‡∏î‡∏∂‡∏á Payment Intent ID ‡∏à‡∏≤‡∏Å URL
    const pathParts = window.location.pathname.split('/');
    const paymentIntentId = pathParts[pathParts.length - 1];
    
    let pollInterval = null;
    let callbackUrl = null;
    let cancelUrl = null;
    let callbackSignature = null;
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Payment Intent
    async function loadPaymentData() {
      try {
        if (!paymentIntentId || paymentIntentId === 'payment') {
          throw new Error('Payment ID not found in URL');
        }
        
        const response = await fetch(`${API_BASE_URL}/payments/${paymentIntentId}?t=${Date.now()}`, { cache: 'no-store' });
        
        if (!response.ok) {
          throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
        }
        
        const data = await response.json();
        callbackSignature = data.callbackSignature || callbackSignature;
        
        // ‡∏î‡∏∂‡∏á callback URLs ‡∏à‡∏≤‡∏Å metadata
        if (data.metadata) {
          callbackUrl = data.metadata.callbackUrl;
          cancelUrl = data.metadata.cancelUrl;
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        document.getElementById('description').textContent = data.description || '‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô';
        document.getElementById('paymentId').textContent = data.id;
        document.getElementById('amount').textContent = `${(data.amount / 100).toFixed(2)} THB`;
        
        // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
        if (data.status === 'succeeded') {
          showSuccess();
          setTimeout(() => redirectToCallback('success'), 2000);
          return;
        }
        
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß
        if (data.status === 'canceled') {
          showError('‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');
          setTimeout(() => redirectToCallback('cancel'), 3000);
          return;
        }
        
        // ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
        document.getElementById('loadingSection').classList.add('hidden');
        document.getElementById('paymentSection').classList.remove('hidden');
        
        // ‡πÇ‡∏´‡∏•‡∏î QR Code
        await loadQRCode();
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏û‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        startPolling();
        
      } catch (error) {
        console.error('Error:', error);
        showError(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
      }
    }
    
    // ‡πÇ‡∏´‡∏•‡∏î QR Code ‡∏à‡∏≤‡∏Å database
    async function loadQRCode() {
      try {
        // ‡∏î‡∏∂‡∏á QR URL ‡∏à‡∏≤‡∏Å metadata ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ
        const response = await fetch(`${API_BASE_URL}/payments/${paymentIntentId}?t=${Date.now()}`, { cache: 'no-store' });
        
        if (!response.ok) {
          throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î QR Code ‡πÑ‡∏î‡πâ');
        }
        
        const data = await response.json();
        console.log('Payment data:', data); // Debug log
        callbackSignature = data.callbackSignature || callbackSignature;
        
        // ‡∏•‡∏≠‡∏á‡∏´‡∏≤ QR URL ‡∏à‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏ó‡∏µ‡πà
        let qrUrl = null;
        
        // 1. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å qrCodeUrl field ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
        if (data.qrCodeUrl) {
          qrUrl = data.qrCodeUrl;
        }
        // 2. ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å metadata.qrCodeUrl
        else if (data.metadata && data.metadata.qrCodeUrl) {
          qrUrl = data.metadata.qrCodeUrl;
        }
        
        if (qrUrl) {
          const qrImage = document.getElementById('qrImage');
          qrImage.src = qrUrl;
          qrImage.style.display = 'block';
          console.log('QR Code loaded:', qrUrl);
        } else {
          // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á message
          console.warn('No QR Code URL found in response');
          document.getElementById('qrContainer').innerHTML = 
            '<p style="color: #666; padding: 20px;">QR Code ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏î‡πâ<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô Payment ID ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô<br><small>(‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Live Mode ‡∏Ç‡∏≠‡∏á Stripe)</small></p>';
        }
          
      } catch (error) {
        console.error('Error loading QR:', error);
        document.getElementById('qrContainer').innerHTML = 
          '<p style="color: #f44336; padding: 20px;">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î QR Code ‡πÑ‡∏î‡πâ<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</p>';
      }
    }
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
    async function checkPaymentStatus() {
      try {
        console.log(`[${new Date().toISOString()}] Checking payment status...`);
        const response = await fetch(`${API_BASE_URL}/payments/${paymentIntentId}`);
        
        if (!response.ok) {
          console.error('Response not OK:', response.status);
          return;
        }
        
        const data = await response.json();
        console.log('Payment status:', data.status, 'Full data:', data);
        callbackSignature = data.callbackSignature || callbackSignature;
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        updateStatusUI(data.status);
        
        // ‡∏ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        if (data.status === 'succeeded') {
          console.log('‚úÖ Payment succeeded! Redirecting...');
          stopPolling();
          showSuccess();
          setTimeout(() => redirectToCallback('success', data), 2000);
        }
        
        // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß
        if (['canceled', 'requires_payment_method'].includes(data.status)) {
          console.warn('‚ùå Payment failed or canceled');
          stopPolling();
          showError('‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
          setTimeout(() => redirectToCallback('cancel'), 3000);
        }
        
      } catch (error) {
        console.error('Error checking status:', error);
      }
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    function updateStatusUI(status) {
      const statusBadge = document.getElementById('statusBadge');
      const statusText = document.getElementById('statusText');
      
      statusBadge.className = 'status';
      
      switch (status) {
        case 'succeeded':
          statusBadge.classList.add('succeeded');
          statusText.innerHTML = '‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!';
          break;
        case 'requires_action':
          statusBadge.classList.add('pending');
          statusText.innerHTML = '<span class="loading"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô...';
          break;
        case 'processing':
          statusBadge.classList.add('pending');
          statusText.innerHTML = '<span class="loading"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...';
          break;
        default:
          statusBadge.classList.add('pending');
          statusText.innerHTML = `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${status}`;
      }
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    function showSuccess() {
      document.getElementById('qrContainer').classList.add('hidden');
      document.getElementById('statusBadge').classList.add('hidden');
      document.getElementById('successSection').classList.remove('hidden');
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
    function showError(message) {
      document.getElementById('loadingSection').classList.add('hidden');
      document.getElementById('paymentSection').classList.add('hidden');
      document.getElementById('errorSection').classList.remove('hidden');
      document.getElementById('errorMessage').textContent = message;
    }
    
    // Redirect ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á
    function redirectToCallback(status, data = {}) {
      const targetUrl = status === 'success' ? callbackUrl : cancelUrl;
      
      if (!targetUrl) {
        console.log('No callback URL specified');
        return;
      }
      
      // ‡πÄ‡∏û‡∏¥‡πà‡∏° query parameters
      const url = new URL(targetUrl);
      url.searchParams.set('payment_id', paymentIntentId);
      url.searchParams.set('status', status);
      
      if (data.amount) {
        url.searchParams.set('amount', data.amount);
      }

      const signature = data.callbackSignature || callbackSignature;
      if (signature) {
        url.searchParams.set('signature', signature);
      }
      
      console.log('Redirecting to:', url.toString());
      window.location.href = url.toString();
    }
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏û‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    function startPolling() {
      // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô polling ‡∏ã‡πâ‡∏≥
      if (pollInterval) {
        console.warn('Polling already started, skipping...');
        return;
      }
      
      console.log('Starting polling every 3 seconds...');
      checkPaymentStatus();
      pollInterval = setInterval(checkPaymentStatus, 3000);
      
      // ‡∏´‡∏¢‡∏∏‡∏î‡πÇ‡∏û‡∏•‡∏´‡∏•‡∏±‡∏á 10 ‡∏ô‡∏≤‡∏ó‡∏µ
      setTimeout(() => {
        if (pollInterval) {
          stopPolling();
          showError('‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
        }
      }, 600000);
    }
    
    // ‡∏´‡∏¢‡∏∏‡∏î‡πÇ‡∏û‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
    }
    
    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏™‡∏£‡πá‡∏à
    window.addEventListener('DOMContentLoaded', loadPaymentData);
  </script>
</body>
</html>
